version: 2.1
orbs:
  kube-orb: circleci/kubernetes@0.10.1
jobs:
  build:
    machine: true
    working_directory: ~/app
    steps:
      - checkout
      - run:
          name: Build and push Docker image
          command: |
            echo "$DOCKER_PASS" | docker login celonet.azurecr.io --username $DOCKER_USER --password-stdin
      - run: docker build -t campanhabrinquedo-api:$CIRCLE_BUILD_NUM .
      - run: docker tag campanhabrinquedo-api:$CIRCLE_BUILD_NUM celonet.azurecr.io/campanhabrinquedo-api:$CIRCLE_BUILD_NUM
      - run: docker push celonet.azurecr.io/campanhabrinquedo-api:$CIRCLE_BUILD_NUM
  deploy:
    machine: true
    steps:
      - kube-orb/install
      - kube-orb/install-kubeconfig:
        kubeconfig: YXBpVmVyc2lvbjogdjEKa2luZDogQ29uZmlnCgpjbHVzdGVyczoKLSBjbHVzdGVyOgogICAgY2VydGlmaWNhdGUtYXV0aG9yaXR5LWRhdGE6IExTMHRMUzFDUlVkSlRpQkRSVkpVU1VaSlEwRlVSUzB0TFMwdENrMUpTVU41UkVORFFXSkRaMEYzU1VKQlowbENRVVJCVGtKbmEzRm9hMmxIT1hjd1FrRlJjMFpCUkVGV1RWSk5kMFZSV1VSV1VWRkVSWGR3Y21SWFNtd0tZMjAxYkdSSFZucE5RalJZUkZSRk5VMUVZM2RPVkVsNVRYcFZlazFHYjFoRVZFazFUVVJqZDAxcVNYbE5lbFY2VFVadmQwWlVSVlJOUWtWSFFURlZSUXBCZUUxTFlUTldhVnBZU25WYVdGSnNZM3BEUTBGVFNYZEVVVmxLUzI5YVNXaDJZMDVCVVVWQ1FsRkJSR2RuUlZCQlJFTkRRVkZ2UTJkblJVSkJUVFZvQ2lzNFIwOURUbU14UTBrMU1HTk1OM0F4UVRCSGFqTkNNVzFGWTNGeFVUQmFkRVptY2pOMlZXVk1Vamt6YVdoaWNuRlZaMWgyZDJSMGQxa3haVkF5UWtzS1pHTkZTbVZ3ZDBJMldpdFFWbkpXV1cxS2REUktjbkZaZGt4TWJXTnlUbXdyVW1kYVNDdHVVMnByZWtNNFdXRkdlV05qTUhSUlprRjBVM04wWlc5b2N3cHhUUzlaWW1ONWIwWXpOMlV5TnpacFVsSXdNazFLZEZSVU5EQm9hMGRxWkhkS0syaFhaME5zYUVwSGVVaFhkMnBUVUdKc2FHWXhUM0YxU0dWVVJUSnRDa2h4WlVSMFF5dEhOVXhzYkc5MVNVMWhSbVp2U1dGT2JWa3hWM2xST0VKa04zTjRjalpGWTBSNmJ6VTVUMFZwYlU1UWRuQnZiR1pIV0ZrclJWZHdWakFLVGtoVFRuWkNPREZuVjFsM1JqVkRTR3RIVkU1c01VOHpNbGQ1VWxsM2FrOXNWR3MzVFc5WFFsWm1UbEowV0RKMlZXOW1RMWRTZEdkMFpreDFkV0ZLUVFvM1RHWjFSR2swTkZaalZrTXZjbGhEUjBrd1EwRjNSVUZCWVUxcVRVTkZkMFJuV1VSV1VqQlFRVkZJTDBKQlVVUkJaMHRyVFVFNFIwRXhWV1JGZDBWQ0NpOTNVVVpOUVUxQ1FXWTRkMFJSV1VwTGIxcEphSFpqVGtGUlJVeENVVUZFWjJkRlFrRkNTQzl2YlZsMU9DdGtjVWhqU1hsdFdtdHpNek5SVFd0clR5OEtRa3hhV1ZOWmJtSldVVEZvWmxFNFpuUkxaWEJhV1dSWVZrUTRLMDluWm1KUldHb3lSVmR5VWxSbU9FNVNZa3hRVVVsU05VUllZMk4xVG5wWVF6QnNlQXB4VW04dmNtRXlTSEZvZG1ZMU5qbHlSWEJtYzB0SGJEUjRWVUZ2VVZWa2RHNUtNMnhDU2l0NE4xcHdMemxNZVU1RWRVZFVNVnB2V1RGWEt6UnBRMDlFQ25scGVrdEdkbXR3ZWxWS1RsZEhNMWhQVVVRM1dYbGtiRUo1TlM4ck1tOVJlVXhWVm10WWRIWTNSMjFVWlhGQ1JqTXlhVGhTTDFBMVJIVlZNVzFpWTNRS1ppdHpOVnB0Tm1wNldIQldkMnhaTnpFeWJISjBOR1ptWVVGM1pqQXJjM1YzWkRnMFNFZHJXVFJ5ZW5GWU4yaEdVa0ZsUlVsaE5qRm5UbkJQWlRGMFNRcHNXREZNWVVod2FGVlNkVXBXTm10TGExVmtMMmhET1cxVFptOWphRVZTY0hSbk5rdEVaRlZXVHpKMldrMXZabWhSZWtGNlYyaDRkMmxSVFQwS0xTMHRMUzFGVGtRZ1EwVlNWRWxHU1VOQlZFVXRMUzB0TFFvPQogICAgc2VydmVyOiBodHRwczovL3VzdzEua3ViZXNhaWwuY29tCiAgbmFtZToga3ViZXNhaWwtY2Vsb25ldAoKdXNlcnM6Ci0gbmFtZToga3ViZXNhaWwtY2Vsb25ldAogIHVzZXI6CiAgICBjbGllbnQta2V5LWRhdGE6IExTMHRMUzFDUlVkSlRpQkRSVkpVU1VaSlEwRlVSUzB0TFMwdENrMUpTVU41UkVORFFXSkRaMEYzU1VKQlowbENRVVJCVGtKbmEzRm9hMmxIT1hjd1FrRlJjMFpCUkVGV1RWSk5kMFZSV1VSV1VWRkVSWGR3Y21SWFNtd0tZMjAxYkdSSFZucE5RalJZUkZSRk5VMUVZM2RPVkVsNVRYcFZlazFHYjFoRVZFazFUVVJqZDAxcVNYbE5lbFY2VFVadmQwWlVSVlJOUWtWSFFURlZSUXBCZUUxTFlUTldhVnBZU25WYVdGSnNZM3BEUTBGVFNYZEVVVmxLUzI5YVNXaDJZMDVCVVVWQ1FsRkJSR2RuUlZCQlJFTkRRVkZ2UTJkblJVSkJUVFZvQ2lzNFIwOURUbU14UTBrMU1HTk1OM0F4UVRCSGFqTkNNVzFGWTNGeFVUQmFkRVptY2pOMlZXVk1Vamt6YVdoaWNuRlZaMWgyZDJSMGQxa3haVkF5UWtzS1pHTkZTbVZ3ZDBJMldpdFFWbkpXV1cxS2REUktjbkZaZGt4TWJXTnlUbXdyVW1kYVNDdHVVMnByZWtNNFdXRkdlV05qTUhSUlprRjBVM04wWlc5b2N3cHhUUzlaWW1ONWIwWXpOMlV5TnpacFVsSXdNazFLZEZSVU5EQm9hMGRxWkhkS0syaFhaME5zYUVwSGVVaFhkMnBUVUdKc2FHWXhUM0YxU0dWVVJUSnRDa2h4WlVSMFF5dEhOVXhzYkc5MVNVMWhSbVp2U1dGT2JWa3hWM2xST0VKa04zTjRjalpGWTBSNmJ6VTVUMFZwYlU1UWRuQnZiR1pIV0ZrclJWZHdWakFLVGtoVFRuWkNPREZuVjFsM1JqVkRTR3RIVkU1c01VOHpNbGQ1VWxsM2FrOXNWR3MzVFc5WFFsWm1UbEowV0RKMlZXOW1RMWRTZEdkMFpreDFkV0ZLUVFvM1RHWjFSR2swTkZaalZrTXZjbGhEUjBrd1EwRjNSVUZCWVUxcVRVTkZkMFJuV1VSV1VqQlFRVkZJTDBKQlVVUkJaMHRyVFVFNFIwRXhWV1JGZDBWQ0NpOTNVVVpOUVUxQ1FXWTRkMFJSV1VwTGIxcEphSFpqVGtGUlJVeENVVUZFWjJkRlFrRkNTQzl2YlZsMU9DdGtjVWhqU1hsdFdtdHpNek5SVFd0clR5OEtRa3hhV1ZOWmJtSldVVEZvWmxFNFpuUkxaWEJhV1dSWVZrUTRLMDluWm1KUldHb3lSVmR5VWxSbU9FNVNZa3hRVVVsU05VUllZMk4xVG5wWVF6QnNlQXB4VW04dmNtRXlTSEZvZG1ZMU5qbHlSWEJtYzB0SGJEUjRWVUZ2VVZWa2RHNUtNMnhDU2l0NE4xcHdMemxNZVU1RWRVZFVNVnB2V1RGWEt6UnBRMDlFQ25scGVrdEdkbXR3ZWxWS1RsZEhNMWhQVVVRM1dYbGtiRUo1TlM4ck1tOVJlVXhWVm10WWRIWTNSMjFVWlhGQ1JqTXlhVGhTTDFBMVJIVlZNVzFpWTNRS1ppdHpOVnB0Tm1wNldIQldkMnhaTnpFeWJISjBOR1ptWVVGM1pqQXJjM1YzWkRnMFNFZHJXVFJ5ZW5GWU4yaEdVa0ZsUlVsaE5qRm5UbkJQWlRGMFNRcHNXREZNWVVod2FGVlNkVXBXTm10TGExVmtMMmhET1cxVFptOWphRVZTY0hSbk5rdEVaRlZXVHpKMldrMXZabWhSZWtGNlYyaDRkMmxSVFQwS0xTMHRMUzFGVGtRZ1EwVlNWRWxHU1VOQlZFVXRMUzB0TFFvPQogICAgdG9rZW46IGV5SmhiR2NpT2lKU1V6STFOaUlzSW10cFpDSTZJaUo5LmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUpqWld4dmJtVjBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbVJsWm1GMWJIUXRkRzlyWlc0dGRtSnlaR29pTENKcmRXSmxjbTVsZEdWekxtbHZMM05sY25acFkyVmhZMk52ZFc1MEwzTmxjblpwWTJVdFlXTmpiM1Z1ZEM1dVlXMWxJam9pWkdWbVlYVnNkQ0lzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJalUzT0RBNE5EWTBMVE15TW1RdE5HTTJOeTFpWWpRd0xUQm1ZbUprTkdNd05tRmpNQ0lzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwalpXeHZibVYwT21SbFptRjFiSFFpZlEuQ0o1QXAyYTlBODBrU2ppeks2RFlTVG1QR2xKdTdza3JNUzJ6RVpGaUh5NlNNdWJTeU91eDhXNFVQUlBicmJiNXhxanRwUTk3NlVxSDFfMWFjR09hX2ZidmZpcXg0bEZ1OTNQcmZfSUNRa3FDeFh3ZVVudWk1Z0lZRHZqcXlPQjBySkNWbEwxbmx6WEk1SFp5N3ljWHFaMjJkZThwMWpEZ0wybHlfRUU1NDJoOU1ad3R6MWhDR09IZW9KR1lqSGlJOVZpZnpDeXJhTzFlemdRakNrWmQ2NVI2N2ppMlE2MjRPOTA2clpISVlURmdhSjN0YU0xRUN2X0FyemQxUUFIRng0NnI0VkFocU14VHh0LURpaHRtNUphNzdJWk4yVFJvZm1xNDFFZlozaDhhME5Ha3RRTzRVZHhhX2U4UVlKUXFOU1o3NjJJRW9vOUJEVTdJUWdWbjlRCgpjb250ZXh0czoKLSBjb250ZXh0OgogICAgY2x1c3Rlcjoga3ViZXNhaWwtY2Vsb25ldAogICAgbmFtZXNwYWNlOiBjZWxvbmV0CiAgICB1c2VyOiBrdWJlc2FpbC1jZWxvbmV0CiAgbmFtZToga3ViZXNhaWwtY2Vsb25ldAoKY3VycmVudC1jb250ZXh0OiBrdWJlc2FpbC1jZWxvbmV0
      - run:
          name: Deploy app to kubesail
          command: |
            kubectl apply -f ./kubernetes/

workflows:
  version: 2            
  campanha_workflow:
    jobs:
      - build
      - deploy:
          requires: 
            - build

